{"version":3,"sources":["../../../src/plugins/IncludePlugin.js"],"names":["_","fs","require","path","IncludePlugin","config","previousSettings","settings","regEx","defaultsDeep","name","data","include","input","inputFile","replaceIncludes","currentFilePath","str","filesAlreadyIncluded","match","directoryPath","dirname","lastIndex","exec","absoluteFilePath","resolve","strToInclude","includes","push","readFileSync","substr","index","length","module","exports"],"mappings":";;;;AAEA;;IAAYA,C;;;;;;AAFZ,IAAIC,KAAKC,QAAQ,IAAR,CAAT;AACA,IAAIC,OAAOD,QAAQ,MAAR,CAAX;;IAGME,a;;;sBACOC,M,EAAO;AAChB,UAAIC,mBAAmB,KAAKC,QAA5B;AACA,UAAG,CAACD,gBAAJ,EAAqB;AACnBA,2BAAmB;AACjBE,iBAAQ;AADS,SAAnB;AAGD;AACD,WAAKD,QAAL,GAAgBP,EAAES,YAAF,CAAe,EAAf,EAAmBJ,MAAnB,EAA2BC,gBAA3B,CAAhB;AACD;;;AACD,yBAAYD,MAAZ,EAAmB;AAAA;;AACjB,SAAKK,IAAL,GAAY,eAAZ;AACA,SAAKL,MAAL,GAAcA,MAAd;AACD;;;;wBACGM,I,EAAK;AACP,UAAGA,KAAKN,MAAL,IAAeM,KAAKN,MAAL,CAAYO,OAA9B,EAAsC;AACpC,aAAKP,MAAL,GAAcM,KAAKN,MAAL,CAAYO,OAA1B;AACD;AACD,UAAG,CAACD,KAAKE,KAAN,IAAe,CAACF,KAAKG,SAAxB,EAAkC;AAChC,eAAOH,IAAP;AACD;AACDA,WAAKE,KAAL,GAAa,KAAKE,eAAL,CAAqBJ,KAAKG,SAA1B,EAAqCH,KAAKE,KAA1C,EAAiD,KAAKN,QAAL,CAAcC,KAA/D,EAAsE,EAAtE,CAAb;AACA,aAAOG,IAAP;AACD;;;oCACeK,e,EAAiBC,G,EAAKT,K,EAAOU,oB,EAAqB;AAChE,UAAIC,QAAQ,IAAZ;AACA,UAAMC,gBAAgBjB,KAAKkB,OAAL,CAAaL,eAAb,CAAtB;AACAR,YAAMc,SAAN,GAAkB,CAAlB;AACA,aAAOH,QAAQX,MAAMe,IAAN,CAAWN,GAAX,CAAf,EAAgC;AAC9B,YAAMO,mBAAmBrB,KAAKsB,OAAL,CAAaL,aAAb,EAA4BD,MAAM,CAAN,CAA5B,CAAzB;AACA,YAAIO,eAAe,EAAnB;AACA,YAAG1B,EAAE2B,QAAF,CAAWT,oBAAX,EAAiCM,gBAAjC,CAAH,EAAsD;AACpDE,yBAAe,iCAAiCF,gBAAjC,GAAoD,wFAAnE;AACD,SAFD,MAEK;AACHN,+BAAqBU,IAArB,CAA0BJ,gBAA1B;AACAE,yBAAezB,GAAG4B,YAAH,CAAgBL,gBAAhB,EAAkC,MAAlC,CAAf;AACA,cAAGE,gBAAgB,IAAnB,EAAwB;AACtBA,2BAAe,iCAAgCF,gBAAhC,GAAkD,qBAAjE;AACD,WAFD,MAEK;AACHE,2BAAe,KAAKX,eAAL,CAAqBS,gBAArB,EAAuCE,YAAvC,EAAqDlB,KAArD,EAA4DU,oBAA5D,CAAf;AACD;AACF;AACDD,cAAMA,IAAIa,MAAJ,CAAW,CAAX,EAAcX,MAAMY,KAApB,IAA6BL,YAA7B,GAA4CT,IAAIa,MAAJ,CAAWX,MAAMY,KAAN,GAAcZ,MAAM,CAAN,EAASa,MAAlC,CAAlD;AACAxB,cAAMc,SAAN,GAAkBH,MAAMY,KAAN,GAAcL,aAAaM,MAA7C;AACD;AACD,aAAOf,GAAP;AACD;;;;;;AAGHgB,OAAOC,OAAP,GAAiB;AACf9B,iBAAeA;AADA,CAAjB","file":"IncludePlugin.js","sourcesContent":["let fs = require('fs');\nlet path = require('path');\nimport * as _ from 'lodash';\n\nclass IncludePlugin{\n  set config(config){\n    let previousSettings = this.settings;\n    if(!previousSettings){\n      previousSettings = {\n        regEx : /@include\\(([^\\)]+)\\)/g\n      }\n    }\n    this.settings = _.defaultsDeep({}, config, previousSettings);\n  }\n  constructor(config){\n    this.name = \"IncludePlugin\";\n    this.config = config;\n  }\n  run(data){\n    if(data.config && data.config.include){\n      this.config = data.config.include;\n    }\n    if(!data.input || !data.inputFile){\n      return data;\n    }\n    data.input = this.replaceIncludes(data.inputFile, data.input, this.settings.regEx, []);\n    return data;\n  }\n  replaceIncludes(currentFilePath, str, regEx, filesAlreadyIncluded){\n    let match = null;\n    const directoryPath = path.dirname(currentFilePath);\n    regEx.lastIndex = 0;\n    while((match = regEx.exec(str))){\n      const absoluteFilePath = path.resolve(directoryPath, match[1]);\n      let strToInclude = '';\n      if(_.includes(filesAlreadyIncluded, absoluteFilePath)){\n        strToInclude = '<!-- Include failed: File \\'' + absoluteFilePath + '\\' already included. To avoid infinite loops, each file can only be included once. -->'\n      }else{\n        filesAlreadyIncluded.push(absoluteFilePath);\n        strToInclude = fs.readFileSync(absoluteFilePath, 'utf8');\n        if(strToInclude == null){\n          strToInclude = '<!-- Include failed: File \\''+ absoluteFilePath +'\\' not found. -->\\n'\n        }else{\n          strToInclude = this.replaceIncludes(absoluteFilePath, strToInclude, regEx, filesAlreadyIncluded);        \n        }        \n      }\n      str = str.substr(0, match.index) + strToInclude + str.substr(match.index + match[0].length);\n      regEx.lastIndex = match.index + strToInclude.length;\n    }\n    return str;\n  }\n}\n\nmodule.exports = {\n  IncludePlugin: IncludePlugin\n}\n"]}